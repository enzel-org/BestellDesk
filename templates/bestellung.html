<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Bestellung aufgeben</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='bestellung.css') }}">
</head>
<body>
    <h1>Bestellung aufgeben</h1>

    {% if hinweis %}
        <p><em>{{ hinweis }}</em></p>
    {% endif %}

    {% if not bestellbar %}
        <p style="color:red;"><strong>Außerhalb des Bestellzeitraums.</strong> Eine Bestellung ist derzeit nicht möglich.</p>
    {% else %}

    {% if lieferant %}
    <div class="lieferant-box">
        <strong>Heute bestellen wir bei: {{ lieferant.name }}</strong><br>
        {% if lieferant.menu_typ == "link" %}
            <a href="{{ lieferant.menu_info }}" target="_blank">Speisekarte öffnen</a><br>
        {% elif lieferant.menu_typ == "text" %}
            <em>{{ lieferant.menu_info }}</em><br>
        {% endif %}
        <small>Versandkosten: {{ "%.2f"|format(lieferant.versand_pro_person) }} € pro Person</small>
    </div>
    {% endif %}

    <form id="bestell-formular">
        <label for="name">Dein Name:</label>
        <input type="text" id="name" name="name" required><br><br>

        <div id="gerichte-container"></div>

        <button type="button" id="gericht-hinzufuegen">+ Gericht hinzufügen</button><br><br>
        <button type="submit">Bestellung absenden</button>
    </form>

    <div id="zusammenfassung">
        <h3>Zusammenfassung</h3>
        <div id="gericht-liste"></div>
        <div>Zwischensumme: <span id="zwischensumme">0.00</span> €</div>
        {% if lieferant %}
            <div>Versandkosten: <span id="versandkosten">{{ "%.2f"|format(lieferant.versand_pro_person) }}</span> €</div>
        {% else %}
            <div>Versandkosten: <span id="versandkosten">0.00</span> €</div>
        {% endif %}
        <strong>Gesamtpreis: <span id="gesamtpreis">0.00</span> €</strong>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const gerichteContainer = document.getElementById("gerichte-container");
            const gerichtListe = document.getElementById("gericht-liste");
            const zwischensummeAnzeige = document.getElementById("zwischensumme");
            const gesamtpreisAnzeige = document.getElementById("gesamtpreis");
            const versandkosten = parseFloat(document.getElementById("versandkosten").textContent) || 0;

            function aktualisiereZusammenfassung() {
                const gerichtElements = gerichteContainer.getElementsByClassName("gericht");
                gerichtListe.innerHTML = "";
                let zwischensumme = 0;

                for (let div of gerichtElements) {
                    const name = div.querySelector("input[name='gericht']").value;
                    const preis = parseFloat(div.querySelector("input[name='preis']").value);
                    const schaerfe = div.querySelector("select[name='schaerfegrad']").value;
                    const notiz = div.querySelector("input[name='notiz']").value;

                    if (name && !isNaN(preis)) {
                        const eintrag = document.createElement("div");
                        eintrag.classList.add("gericht-eintrag");
                        eintrag.textContent = `${name} (${schaerfe}${notiz ? " – " + notiz : ""}) – ${preis.toFixed(2)} €`;
                        gerichtListe.appendChild(eintrag);
                        zwischensumme += preis;
                    }
                }

                zwischensummeAnzeige.textContent = zwischensumme.toFixed(2);
                const gesamt = zwischensumme + versandkosten;
                gesamtpreisAnzeige.textContent = gesamt.toFixed(2);
            }

            document.getElementById("gericht-hinzufuegen").addEventListener("click", function () {
                const gerichtDiv = document.createElement("div");
                gerichtDiv.classList.add("gericht");

                gerichtDiv.innerHTML = `
                    <input type="text" name="nr" placeholder="Gericht Nr.">
                    <input type="text" name="gericht" placeholder="Name">
                    <input type="number" step="0.01" name="preis" placeholder="Preis">
                    <select name="schaerfegrad">
                        <option value="Keine" selected>Keine Schärfe</option>
                        <option value="Mild">Mild</option>
                        <option value="Mittel">Mittel</option>
                        <option value="Scharf">Scharf</option>
                        <option value="Extra Scharf">Extra Scharf</option>
                    </select>
                    <input type="text" name="notiz" placeholder="Notiz (optional)">
                    <button type="button" class="entfernen">Entfernen</button>
                `;

                gerichtDiv.querySelectorAll("input, select").forEach(el => {
                    el.addEventListener("input", aktualisiereZusammenfassung);
                });

                gerichtDiv.querySelector(".entfernen").addEventListener("click", function () {
                    gerichtDiv.remove();
                    aktualisiereZusammenfassung();
                });

                gerichteContainer.appendChild(gerichtDiv);
                aktualisiereZusammenfassung();
            });

            document.getElementById("bestell-formular").addEventListener("submit", function (e) {
                e.preventDefault();

                const name = document.getElementById("name").value;
                const gerichtElements = gerichteContainer.getElementsByClassName("gericht");

                const gerichte = [];

                for (let div of gerichtElements) {
                    const nr = div.querySelector("input[name='nr']").value;
                    const gerichtName = div.querySelector("input[name='gericht']").value;
                    const preis = parseFloat(div.querySelector("input[name='preis']").value);
                    const schaerfe = div.querySelector("select[name='schaerfegrad']").value;
                    const notiz = div.querySelector("input[name='notiz']").value;

                    if (gerichtName && !isNaN(preis)) {
                        gerichte.push({
                            nr: nr,
                            name: gerichtName,
                            preis: preis,
                            schaerfegrad: schaerfe,
                            notiz: notiz
                        });
                    }
                }

                fetch("/api/bestellung", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ name: name, gerichte: gerichte })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === "ok") {
                        alert("Bestellung gesendet!");
                        location.reload();
                    } else {
                        alert("Fehler: " + data.reason);
                    }
                })
                .catch(err => {
                    alert("Fehler beim Senden!");
                    console.error(err);
                });
            });
        });
    </script>
    {% endif %}
</body>
</html>
