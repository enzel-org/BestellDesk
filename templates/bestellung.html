<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Bestellung aufgeben</title>
    <style>
        .gericht {
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #ccc;
        }
        #zusammenfassung {
            margin-top: 30px;
            padding: 10px;
            border-top: 2px solid #000;
        }
        .gericht-eintrag {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <h1>Bestellung aufgeben</h1>

    <form id="bestell-formular">
        <label for="name">Dein Name:</label>
        <input type="text" id="name" name="name" required><br><br>

        <div id="gerichte-container"></div>

        <button type="button" id="gericht-hinzufuegen">+ Gericht hinzufügen</button><br><br>
        <button type="submit">Bestellung absenden</button>
    </form>

    <div id="zusammenfassung">
        <h3>Zusammenfassung</h3>
        <div id="gericht-liste"></div>
        <strong>Gesamtpreis: <span id="gesamtpreis">0.00</span> €</strong>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const gerichteContainer = document.getElementById("gerichte-container");
            const gerichtListe = document.getElementById("gericht-liste");
            const gesamtpreisAnzeige = document.getElementById("gesamtpreis");

            function aktualisiereZusammenfassung() {
                const gerichtElements = gerichteContainer.getElementsByClassName("gericht");
                gerichtListe.innerHTML = "";
                let gesamtpreis = 0;

                for (let div of gerichtElements) {
                  const name = div.querySelector("input[name='gericht']").value;
                  const preis = parseFloat(div.querySelector("input[name='preis']").value);
                  const schaerfe = div.querySelector("select[name='schaerfegrad']").value;
                  const notiz = div.querySelector("input[name='notiz']").value;

                  if (name && !isNaN(preis)) {
                      const eintrag = document.createElement("div");
                      eintrag.classList.add("gericht-eintrag");
                      eintrag.textContent = `${name} (${schaerfe}${notiz ? " – " + notiz : ""}) – ${preis.toFixed(2)} €`;
                      gerichtListe.appendChild(eintrag);
                      gesamtpreis += preis;
                  }
               }


                gesamtpreisAnzeige.textContent = gesamtpreis.toFixed(2);
            }

            document.getElementById("gericht-hinzufuegen").addEventListener("click", function () {
                const gerichtDiv = document.createElement("div");
                gerichtDiv.classList.add("gericht");

                gerichtDiv.innerHTML = `
                    <input type="text" name="nr" placeholder="Gericht Nr.">
                    <input type="text" name="gericht" placeholder="Name">
                    <input type="number" step="0.01" name="preis" placeholder="Preis">
                    <select name="schaerfegrad">
                        <option value="Keine" selected>Keine Schärfe</option>
                        <option value="Mild">Mild</option>
                        <option value="Mittel">Mittel</option>
                        <option value="Scharf">Scharf</option>
                        <option value="Extra">Extra Scharf</option>
                    </select>
                    <input type="text" name="notiz" placeholder="Notiz (optional)">
                    <button type="button" class="entfernen">Entfernen</button>
                `;


                gerichtDiv.querySelectorAll("input, select").forEach(el => {
                    el.addEventListener("input", aktualisiereZusammenfassung);
                });

                gerichtDiv.querySelector(".entfernen").addEventListener("click", function () {
                    gerichtDiv.remove();
                    aktualisiereZusammenfassung();
                });

                gerichteContainer.appendChild(gerichtDiv);
                aktualisiereZusammenfassung();
            });

            document.getElementById("bestell-formular").addEventListener("submit", function (e) {
                e.preventDefault();

                const name = document.getElementById("name").value;
                const gerichtElements = gerichteContainer.getElementsByClassName("gericht");

                const gerichte = [];

                for (let div of gerichtElements) {
                  const nr = div.querySelector("input[name='nr']").value;
                  const gerichtName = div.querySelector("input[name='gericht']").value;
                  const preis = parseFloat(div.querySelector("input[name='preis']").value);
                  const schaerfe = div.querySelector("select[name='schaerfegrad']").value;
                  const notiz = div.querySelector("input[name='notiz']").value;

                  if (gerichtName && !isNaN(preis)) {
                      gerichte.push({
                          nr: nr,
                          name: gerichtName,
                          preis: preis,
                          schaerfegrad: schaerfe,
                          notiz: notiz
                      });
                  }
                }

                fetch("/api/bestellung", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ name: name, gerichte: gerichte })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === "ok") {
                        alert("Bestellung gesendet!");
                        location.reload();
                    } else {
                        alert("Fehler: " + data.reason);
                    }
                })
                .catch(err => {
                    alert("Fehler beim Senden!");
                    console.error(err);
                });
            });
        });
    </script>
</body>
</html>
